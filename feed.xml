<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.3.3">Jekyll</generator><link href="https://tomdemeyere.github.io/feed.xml" rel="self" type="application/atom+xml"/><link href="https://tomdemeyere.github.io/" rel="alternate" type="text/html" hreflang="en"/><updated>2024-02-05T16:10:46+00:00</updated><id>https://tomdemeyere.github.io/feed.xml</id><title type="html">blank</title><entry><title type="html">Use the Quantum Accelerator to improve your DFT calculations</title><link href="https://tomdemeyere.github.io/blog/2024/quacc-espresso/" rel="alternate" type="text/html" title="Use the Quantum Accelerator to improve your DFT calculations"/><published>2024-02-04T21:00:00+00:00</published><updated>2024-02-04T21:00:00+00:00</updated><id>https://tomdemeyere.github.io/blog/2024/quacc-espresso</id><content type="html" xml:base="https://tomdemeyere.github.io/blog/2024/quacc-espresso/"><![CDATA[<p>Not long ago, I was looking at the <a href="https://wiki.fysik.dtu.dk/ase/">Atomic Simulation Environment</a> (ASE) <a href="https://wiki.fysik.dtu.dk/ase/ecosystem.html">ecosystem page</a>, when I noticed a new contender: The Quantum Accelerator (Quacc) from the <a href="https://rosen.cbe.princeton.edu">Rosen group</a> at Princeton. It is a new Python package that aims to connect computational chemistry codes to various workflow engines. I quickly got hooked and tried to use it for my work. The package runs around the Atomic Simulation Environment (ASE) and provides recipes and presets to run calculations with ease. You don’t necessarily have to use a workflow engine to use it, this tutorial will not use any. <a href="https://quantum-accelerators.github.io/quacc/install/install.html#installing-quacc">The installation</a> is pretty standard, the only important thing is that you will need the latest ASE version from git before installing it.</p> <p>Unfortunately, at the time there was no implementation for Quantum Espresso, I did my own and merged it to the main repository. If you know how to use the ASE Espresso interface, Quacc will not be difficult to get your head around.</p> <h3 id="espresso-tutorial">Espresso tutorial</h3> <p>Before running everything, Quacc has a configuration file that you must setup correctly to run Espresso calculations. Two important things to set are the path to the Espresso binary and the pseudopotential directory. This configuration file is by default located at <code class="language-plaintext highlighter-rouge">~/.quacc.yaml</code>. Let’s use the CLI to set it up:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>quacc <span class="nb">set </span>ESPRESSO_BIN_DIR /path/to/espresso/bin
quacc <span class="nb">set </span>ESPRESSO_PSEUDO /path/to/espresso/pseudopotentials
</code></pre></div></div> <p>If you open the configuration file you should notice the changes. For the purpose of this tutorial, you will need to set the <code class="language-plaintext highlighter-rouge">ESPRESSO_PSEUDO</code> setting to a folder that contains the full <a href="https://www.materialscloud.org/discover/sssp/table/efficiency">SSSP 1.3.0 efficiency</a> pseudopotential library.</p> <p>Now, let’s try to run a simple calculation. Quacc contains recipes and everything is done under the hood, no need for you to write input files. Let’s try to run a simple calculation for a bulk system.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">ase.build</span> <span class="kn">import</span> <span class="n">bulk</span>
<span class="kn">from</span> <span class="n">quacc.recipes.espresso.core</span> <span class="kn">import</span> <span class="n">static_job</span>

<span class="n">atoms</span> <span class="o">=</span> <span class="nf">bulk</span><span class="p">(</span><span class="sh">"</span><span class="s">Si</span><span class="sh">"</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="nf">static_job</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
</code></pre></div></div> <p><strong>That’s it! You just ran a DFT calculation!</strong></p> <hr/> <h5 id="where-are-the-results"><strong>Where are the results?</strong></h5> <p>Results are stored in the variable <code class="language-plaintext highlighter-rouge">results</code> which is a dictionary.</p> <ul> <li><code class="language-plaintext highlighter-rouge">results["atoms"]</code> contains the final ASE Atoms object.</li> <li><code class="language-plaintext highlighter-rouge">results["results"]</code> contains results from the ASE calculator, such as the energy, forces…</li> <li><code class="language-plaintext highlighter-rouge">results["input_atoms"]</code> contains information about atoms sent to the job.</li> <li><code class="language-plaintext highlighter-rouge">results["dir_name"]</code> contains the directory where the calculation was ran.</li> </ul> <p>There are other keys in the dictionary, but these are the most important ones. Printing the dictionary will give you a better idea of what’s inside.</p> <p>For files, by default, Quacc creates folders in the current working directory that you will quickly notice. Calculations are run in temporary folders and at the end files are moved and gzipped to a permanent folder. If this behaviour seems strange, it makes more sense when you consider the use of workflow engines. Settings are available to change the default behaviour; if you want more information about directory management, the Quacc documentation has a nice <a href="https://quantum-accelerators.github.io/quacc/user/settings/file_management.html">page</a> about it.</p> <hr/> <h5 id="how-do-i-change-the-espresso-keywords"><strong>How do I change the Espresso keywords?</strong></h5> <p>The static_job is pretty much a wrapper around the ASE Espresso calculator for this purpose. You can pass any parameter that you would pass to the Espresso calculator. Here are some examples:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># input_data in flat dictionary format
</span><span class="nf">static_job</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">input_data</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">ecutwfc</span><span class="sh">"</span><span class="p">:</span> <span class="mi">40</span><span class="p">},</span> <span class="n">kpts</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="c1"># input_data in nested dictionary format, kspacing in units of 1/Å
</span><span class="nf">static_job</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">input_data</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">ecutwfc</span><span class="sh">"</span><span class="p">:</span> <span class="mi">40</span><span class="p">}},</span> <span class="n">kspacing</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span>
</code></pre></div></div> <hr/> <h5 id="what-are-the-static_job-parameters"><strong>What are the static_job parameters?</strong></h5> <p>Let’s look at the static_job signature:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@job</span>
<span class="k">def</span> <span class="nf">static_job</span><span class="p">(</span>
    <span class="n">atoms</span><span class="p">:</span> <span class="n">Atoms</span><span class="p">,</span>
    <span class="n">preset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="sh">"</span><span class="s">sssp_1.3.0_pbe_efficiency</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">parallel_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">test_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">copy_files</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">calc_kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RunSchema</span><span class="p">:</span>
</code></pre></div></div> <p>The preset parameter is the one that defines the pseudopotentials here, it is doing so by looking at a yaml file located in the <code class="language-plaintext highlighter-rouge">ESPRESSO_PRESET</code> directory. By default, this directory is located inside the Quacc package and no further setup is required. The custom Espresso calculator will look at the recommended cutoff for the elements in the calculation and take the highest one automatically. Preset files for Espresso can be browsed on the <a href="https://github.com/Quantum-Accelerators/quacc/tree/main/src/quacc/calculators/espresso/presets">Quacc github</a>. You will notice the existence of other presets such as “esm_metal_slab_efficiency.yaml” or “tough_metal_clusters_efficiency.yaml” which additionally change the <code class="language-plaintext highlighter-rouge">input_data</code>. <strong>Of course, any parameters manually passed that conflict with the preset will override it</strong>. If presets are not of interest to you, just set it to <code class="language-plaintext highlighter-rouge">None</code>.</p> <p>Let’s look at the other parameters, the <code class="language-plaintext highlighter-rouge">parallel_info</code> parameter is used to define the parallelization settings, ASE style. The <code class="language-plaintext highlighter-rouge">test_run</code> parameter is used to run a test calculation, it will create a “pwscf.EXIT” file which instructs pw.x to perform a dry-run, useful for checking that your input does not contain any errors. The <code class="language-plaintext highlighter-rouge">copy_files</code> parameter is used to copy files from specified directories to the calculation directory, useful for restarting for example.</p> <hr/> <h5 id="how-do-i-run-anything-else"><strong>How do I run anything else?</strong></h5> <p>I implemented various recipes in Quacc for Espresso, you can find them in the <a href="https://quantum-accelerators.github.io/quacc/user/recipes/recipes_list.html#quantum-espresso">documentation</a>. Since I recently extended the ASE Espresso interface to other binaries, it is now possible to use other binaries such as ph.x, pp.x, dos.x, etc…</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">quacc.recipes.espresso.core</span> <span class="kn">import</span> <span class="n">ase_relax_job</span>
<span class="kn">from</span> <span class="n">quacc.recipes.espresso.phonons</span> <span class="kn">import</span> <span class="n">phonon_job</span>

<span class="n">relax_results</span> <span class="o">=</span> <span class="nf">ase_relax_job</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
<span class="n">phonon_results</span> <span class="o">=</span> <span class="nf">phonon_job</span><span class="p">(</span><span class="n">relax_results</span><span class="p">[</span><span class="sh">"</span><span class="s">dir_name</span><span class="sh">"</span><span class="p">])</span>
</code></pre></div></div> <p>The above code will run a relaxation calculation using ASE optimizers and then run a phonon calculation using ph.x. Similarly, you can change the parameters of the phonon calculations by passing input_data and other parameters to the phonon_job function, everything should be described in the documentation. The Espresso calculator in Quacc takes care of activating restart keywords such as <code class="language-plaintext highlighter-rouge">startingpot</code> and <code class="language-plaintext highlighter-rouge">startingwfc</code> during the optimization phase to avoid starting from scratch at each step. Of course, if you want to use the Espresso internal optimizer, you can use the <code class="language-plaintext python highlighter-rouge">quacc.recipes.espresso.core.relax_job</code> function.</p> <hr/> <p>That’s it for this post! This is probably the first part of a series of posts about Quacc. Here is what to expect from the next blog posts:</p> <ol> <li> <p>Why do we need workflow engines; how to create your own workflows; how to run them on HPC.</p> </li> <li> <p>How to use a monkey-patched version of ASE’s NEB class to run calculations concurrently on HPC without the need for explicit parallel code.</p> </li> <li> <p>How to modify an ASE dynamics object to perform additional actions, such as projwfc.x or pp.x jobs at a predefined interval in an optimization or MD run.</p> </li> </ol> <p>In the meantime, if you are interested you can learn more by having a look at the <a href="https://quantum-accelerators.github.io/quacc/">Quacc documentation</a>. Or wait until I write a post about it in the coming days!</p>]]></content><author><name></name></author><category term="Quacc"/><category term="DFT"/><category term="Espresso"/><category term="ASE"/><summary type="html"><![CDATA[I recently discovered Quacc and I implemented an interface for the Quantum Espresso code. Let's try it!]]></summary></entry></feed>