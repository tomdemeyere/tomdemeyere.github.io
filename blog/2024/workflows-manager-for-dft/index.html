<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Use Parsl to create concurrent computational chemistry workflows | Tom Demeyere</title> <meta name="author" content="Tom Demeyere"> <meta name="description" content="Quacc &amp; Parsl, concurrent workflows for DFT calculations."> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://tomdemeyere.github.io/blog/2024/workflows-manager-for-dft/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Tom </span>Demeyere</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Use Parsl to create concurrent computational chemistry workflows</h1> <p class="post-meta">March 20, 2024</p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/quacc"> <i class="fa-solid fa-hashtag fa-sm"></i> Quacc</a>   <a href="/blog/tag/dft"> <i class="fa-solid fa-hashtag fa-sm"></i> DFT</a>   <a href="/blog/tag/espresso"> <i class="fa-solid fa-hashtag fa-sm"></i> Espresso</a>   <a href="/blog/tag/parsl"> <i class="fa-solid fa-hashtag fa-sm"></i> Parsl</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>A few weeks ago I posted my <a href="https://tomdemeyere.github.io/blog/2024/quacc-espresso/">first blog post</a> where I explain how to use the new Quantum Accelerator (Quacc) package to run DFT calculations with Quantum Espresso. In this blog post, I will show you how to use Quacc in combination with the Parsl workflow engine to create concurrent workflows for DFT calculations. This will allow you to run multiple calculations concurrently on your local machine or on a high-performance computing cluster.</p> <h3 id="quacc--parsl-tutorial">Quacc &amp; Parsl tutorial</h3> <p>If you never ran a Quacc calculation before, I recommend you to either read the <a href="https://quantum-accelerators.github.io/quacc/" rel="external nofollow noopener" target="_blank">Quacc documentation</a> or read my previous blog post. In this blog post, I will assume you have Quacc installed and that you have set up the configuration file correctly.</p> <p>Before we start, you will need to install <a href="https://parsl-project.org" rel="external nofollow noopener" target="_blank">Parsl</a>:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>parsl
</code></pre></div></div> <p>Now that you have Parsl installed, you can configure Quacc to use this workflow engine by changing your .quacc.yaml:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>quacc <span class="nb">set </span>WORKFLOW_ENGINE parsl
</code></pre></div></div> <p>For the purpose of this tutorial, I will assume a similar setup than in my previous blog-post:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">ESPRESSO_PSEUDO</code> is sets to a folder that contains the full <a href="https://www.materialscloud.org/discover/sssp/table/efficiency" rel="external nofollow noopener" target="_blank">SSSP 1.3.0 efficiency</a> pseudopotential library.</li> <li> <code class="language-plaintext highlighter-rouge">ESPRESSO_BIN_DIR</code> is set to the path of the Quantum Espresso binaries.</li> </ul> <p>The aim of the tutorial is to compute the phonon dispersion of multiple bulk crystals using the espresso <code class="language-plaintext highlighter-rouge">ph.x</code> code. The <code class="language-plaintext highlighter-rouge">grid_phonon_workflow</code> <a href="https://quantum-accelerators.github.io/quacc/reference/quacc/recipes/espresso/phonons.html#quacc.recipes.espresso.phonons.grid_phonon_flow" rel="external nofollow noopener" target="_blank">available in Quacc</a> will make this problem embarrassingly parallel by performing each representation of each q-points separetely. Using Parsl these calculations are then done concurently automatically depending on the ressource available.</p> <p>The base code to run this calculation is fairly simple, it first runs a variable-cell relaxation, and then use the results to run the phonon calculation. From there we can extract the force constant using <code class="language-plaintext highlighter-rouge">q2r.x</code> and then call <code class="language-plaintext highlighter-rouge">matdyn.x</code> to compute the phonon dispersion on a arbitrary q-point grid. The main function is descriped below, for now let’s skip the technical details and focus on the functions being called:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">grid_phonon_flow</code> is a pre-made <code class="language-plaintext highlighter-rouge">@flow</code> in Quacc, that contains multiple <code class="language-plaintext highlighter-rouge">@job</code>, details can be found in the documentation.</li> <li> <code class="language-plaintext highlighter-rouge">q2r_job</code> is a pre-made <code class="language-plaintext highlighter-rouge">@job</code> that runs the <code class="language-plaintext highlighter-rouge">q2r.x</code>.</li> <li> <code class="language-plaintext highlighter-rouge">matdyn_job</code> is a pre-made <code class="language-plaintext highlighter-rouge">@job</code> that runs the <code class="language-plaintext highlighter-rouge">matdyn.x</code>.</li> </ul> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@subflow</span>
<span class="k">def</span> <span class="nf">grid_phonon_dos_subflow</span><span class="p">(</span><span class="n">atoms_list</span><span class="p">):</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">atoms_list</span><span class="p">:</span>
        <span class="n">grid_phonon_results</span> <span class="o">=</span> <span class="nf">grid_phonon_flow</span><span class="p">(</span>
            <span class="n">atoms</span><span class="p">,</span>
            <span class="n">job_params</span><span class="o">=</span><span class="n">grid_phonon_params</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">q2r_results</span> <span class="o">=</span> <span class="nf">q2r_job</span><span class="p">(</span><span class="n">grid_phonon_results</span><span class="p">[</span><span class="sh">"</span><span class="s">dir_name</span><span class="sh">"</span><span class="p">],</span> <span class="o">**</span><span class="n">q2r_params</span><span class="p">)</span>
        <span class="n">matdyn_results</span> <span class="o">=</span> <span class="nf">matdyn_job</span><span class="p">(</span><span class="n">q2r_results</span><span class="p">[</span><span class="sh">"</span><span class="s">dir_name</span><span class="sh">"</span><span class="p">],</span> <span class="o">**</span><span class="n">matdyn_params</span><span class="p">)</span>
        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">matdyn_results</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></div> <p>The aim is then simple, we take a list of ASE <code class="language-plaintext highlighter-rouge">Atoms</code> objects, and we run this custom workflow for each of them. Each results are then stored in a list and returned.</p> <hr> <h5 id="setting-up-parsl"><strong>Setting up Parsl</strong></h5> <p>You will need to configure Parsl before using it. In this tutorial, Parsl is run locally and will submit each jobs to an HPC scheduler (slurm in this tutorial). All these options need to be specified via the Parsl configuration. Of course, as done similarly in my previous post, you can perfectly run this code without setting up any workflow engine.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">parsl.config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="n">parsl.executors</span> <span class="kn">import</span> <span class="n">HighThroughputExecutor</span>
<span class="kn">from</span> <span class="n">parsl.launchers</span> <span class="kn">import</span> <span class="n">SimpleLauncher</span>
<span class="kn">from</span> <span class="n">parsl.providers</span> <span class="kn">import</span> <span class="n">SlurmProvider</span>

<span class="n">CONFIG</span> <span class="o">=</span> <span class="nc">Config</span><span class="p">(</span>
    <span class="n">executors</span><span class="o">=</span><span class="p">[</span>
        <span class="nc">HighThroughputExecutor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">short-large</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">max_workers</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>  <span class="c1"># max number of @job to run concurently.
</span>            <span class="n">cores_per_worker</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span>  <span class="c1"># number of cores per worker, &lt; 1 to oversubscribe.
</span>            <span class="n">provider</span><span class="o">=</span><span class="nc">SlurmProvider</span><span class="p">(</span>
                <span class="n">account</span><span class="o">=</span><span class="sh">"</span><span class="s">e89-soto</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># your account code.
</span>                <span class="n">qos</span><span class="o">=</span><span class="sh">"</span><span class="s">short</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># which quality of service.
</span>                <span class="n">worker_init</span><span class="o">=</span><span class="n">worker_init</span><span class="p">,</span>  <span class="c1"># bash lines that will run before each @job
</span>                <span class="n">walltime</span><span class="o">=</span><span class="sh">"</span><span class="s">00:20:00</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">nodes_per_block</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>  <span class="c1"># nodes for each slurm job (block)
</span>                <span class="n">cores_per_node</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># How many threads to use per parsl worker.
</span>                <span class="n">partition</span><span class="o">=</span><span class="sh">"</span><span class="s">standard</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">init_blocks</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># To be kept to 0, especially if you are using different executors.
</span>                <span class="n">max_blocks</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Max number of slurm_jobs.
</span>                <span class="n">launcher</span><span class="o">=</span><span class="nc">SimpleLauncher</span><span class="p">(),</span>  <span class="c1"># Control where Parsl will live,
</span>            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">parsl</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">)</span>
</code></pre></div></div> <p>The terminology is a bit different from what you might be used to, here is a quick summary:</p> <ul> <li> <p><code class="language-plaintext highlighter-rouge">blocks</code> is the number of actual slurm jobs. You have total control over that by using the keywords <code class="language-plaintext highlighter-rouge">init_blocks</code>, <code class="language-plaintext highlighter-rouge">min_blocks</code> and <code class="language-plaintext highlighter-rouge">max_blocks</code>. By default the pilot job model is used, which means that <code class="language-plaintext highlighter-rouge">max_blocks = 1</code>, you can increase this number to fit your needs.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">workers</code> is also a concept introduced by Parsl, this is a computing unit that will take care of running a <code class="language-plaintext highlighter-rouge">@job</code>. In practice, this number will dictate how many of your <code class="language-plaintext highlighter-rouge">@job</code>’s can run concurently.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">launcher</code> dictates how the parsl command is wrapped before being launched, the <code class="language-plaintext highlighter-rouge">SimpleLauncher</code> used here means that it does not use any wrapping; the parsl process will only run on the mother node. The <code class="language-plaintext highlighter-rouge">SingleNodeLauncher</code> will run the parsl process on each node, and might be used as well.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">cores_per_worker</code> is the number of cores that will be used by each worker. In the case of computational chemistry you will often see that it is set to something very low, this means that multiple workers can live on the same threads. There is no need to tweak <code class="language-plaintext highlighter-rouge">cores_per_node</code>.</p> </li> </ul> <p>These parallelisation options are not to be seen as the one which will affect your individual DFT calculations but more as a <strong>total</strong> parallelisation that will dictate how much ressource this <code class="language-plaintext highlighter-rouge">executor</code> can use. Your DFT calculations are then dispatched inside this executor, their parallelisation will be specified later.</p> <p><code class="language-plaintext highlighter-rouge">worker_init</code> should have anything you need to run your software, the machine I use do not have access to the home system from the compute nodes, so I need to to load a ‘scratch’ bashrc that contains the conda init. This is done by adding the following lines:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">worker_init</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
source /path/inside/scratch/.bashrc # Load your bashrc that contains the conda init.
conda activate quacc # Activate the conda environment.

export QUACC_CONFIG_FILE=/path/inside/scratch/.quacc.yaml # Quacc config in scratch space.

module load PrgEnv-gnu
module load cray-fftw cray-hdf5-parallel

export LD_LIBRARY_PATH=$CRAY_LD_LIBRARY_PATH:$LD_LIBRARY_PATH
</span><span class="sh">"""</span>
</code></pre></div></div> <hr> <h5 id="specifying-parameters-and-parallelization"><strong>Specifying parameters and parallelization</strong></h5> <p>Before running the workflow you need to setup the parameters that will be sent to each flow and job, namely the <code class="language-plaintext highlighter-rouge">grid_phonon_params</code>, <code class="language-plaintext highlighter-rouge">matdyn_params</code> and <code class="language-plaintext highlighter-rouge">q2r_params</code>. For the parallelisation, currently the Quacc Espresso interface use the new <code class="language-plaintext highlighter-rouge">parallel_info</code> mechanism introduced in ASE. Here we will use the <code class="language-plaintext highlighter-rouge">srun</code> command with its options. This is done by setting the <code class="language-plaintext highlighter-rouge">parallel_info</code> variable in the <code class="language-plaintext highlighter-rouge">grid_phonon_params</code> and <code class="language-plaintext highlighter-rouge">matdyn_params</code> dictionaries.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parallel_info</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">srun</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">-vv</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">--hint=nomultithread</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">--distribution=block:block</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">-N</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">-n</span><span class="sh">"</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">-c</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">pw_input_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">control</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">forc_conv_thr</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.0001</span><span class="p">},</span>
    <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">occupations</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">smearing</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">degauss</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">smearing</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">cold</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">electrons</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">conv_thr</span><span class="sh">"</span><span class="p">:</span> <span class="mf">1e-12</span><span class="p">,</span> <span class="sh">"</span><span class="s">mixing_mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">TF</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mixing_beta</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">},</span>
    <span class="sh">"</span><span class="s">ions</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span>
    <span class="sh">"</span><span class="s">cell</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">press_conv_thr</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
<span class="p">}</span>

<span class="n">ph_input_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">inputph</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">tr2_ph</span><span class="sh">"</span><span class="p">:</span> <span class="mf">1.0e-12</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">alpha_mix(1)</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">nmix_ph</span><span class="sh">"</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ldisp</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">nq1</span><span class="sh">"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">nq2</span><span class="sh">"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">nq3</span><span class="sh">"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="n">matdyn_input_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">asr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">crystal</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">dos</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">nk1</span><span class="sh">"</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">nk2</span><span class="sh">"</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">nk3</span><span class="sh">"</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">deltaE</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="n">grid_phonon_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">relax_job</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">input_data</span><span class="sh">"</span><span class="p">:</span> <span class="n">pw_input_data</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">kspacing</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">relax_cell</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parallel_info</span><span class="sh">"</span><span class="p">:</span> <span class="n">parallel_info</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">ph_job</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">input_data</span><span class="sh">"</span><span class="p">:</span> <span class="n">ph_input_data</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parallel_info</span><span class="sh">"</span><span class="p">:</span> <span class="n">parallel_info</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="n">matdyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">input_data</span><span class="sh">"</span><span class="p">:</span> <span class="n">matdyn_input_data</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parallel_info</span><span class="sh">"</span><span class="p">:</span> <span class="n">parallel_info</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">q2r_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">parallel_info</span><span class="sh">"</span><span class="p">:</span> <span class="n">parallel_info</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div> <p>All these lines and config are to be placed before the <code class="language-plaintext highlighter-rouge">@subflow</code> “grid_phonon_dos_subflow”. You can access the complete script on my github page. At this point you can create an atoms list of bulk crystals and call the function.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">ase.build</span> <span class="kn">import</span> <span class="n">bulk</span>

<span class="n">atoms_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nf">bulk</span><span class="p">(</span><span class="sh">"</span><span class="s">Al</span><span class="sh">"</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="nf">bulk</span><span class="p">(</span><span class="sh">"</span><span class="s">Cu</span><span class="sh">"</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="nf">bulk</span><span class="p">(</span><span class="sh">"</span><span class="s">Ag</span><span class="sh">"</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="nf">bulk</span><span class="p">(</span><span class="sh">"</span><span class="s">Au</span><span class="sh">"</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="nf">bulk</span><span class="p">(</span><span class="sh">"</span><span class="s">Ni</span><span class="sh">"</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="nf">bulk</span><span class="p">(</span><span class="sh">"</span><span class="s">Pd</span><span class="sh">"</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="nf">bulk</span><span class="p">(</span><span class="sh">"</span><span class="s">Pt</span><span class="sh">"</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="nf">bulk</span><span class="p">(</span><span class="sh">"</span><span class="s">Li</span><span class="sh">"</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">future</span> <span class="o">=</span> <span class="nf">grid_phonon_dos_flow</span><span class="p">(</span><span class="n">atoms_list</span><span class="p">)</span>
</code></pre></div></div> <p>At this stage, running the Python script doesn’t produce any output. This is because Parsl is now handling the function call, and it is only generating the <a href="(https://en.wikipedia.org/wiki/Directed\_acyclic\_graph)">Directed Acyclic Graph (DAG)</a>, which is an internal representation of the workflow. The returned object is a future object. To actually execute the workflow, the future object needs to be resolved by calling the <code class="language-plaintext highlighter-rouge">Future.result()</code> method.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">results</span> <span class="o">=</span> <span class="n">future</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
</code></pre></div></div> <p>If you have important disparities between the size of your jobs, Parsl allows you to define multiple executors. To do, you just need to add a new executor to the <code class="language-plaintext highlighter-rouge">CONFIG</code> object. You simply need to add one more executors in the list. I will not show it here, but the code is available on my <a href="">github</a>. Using Quacc each job can be linked to a single executor to make sure to run your jobs using the ressources you want.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">q2r_job_custom</span> <span class="o">=</span> <span class="nf">redecorate</span><span class="p">(</span><span class="n">q2r_job</span><span class="p">,</span> <span class="nf">job</span><span class="p">(</span><span class="n">executors</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">q2r</span><span class="sh">"</span><span class="p">]))</span>
<span class="n">matdyn_job_custom</span> <span class="o">=</span> <span class="nf">redecorate</span><span class="p">(</span><span class="n">matdyn_job</span><span class="p">,</span> <span class="nf">job</span><span class="p">(</span><span class="n">executors</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">matdyn</span><span class="sh">"</span><span class="p">]))</span>
</code></pre></div></div> <hr> <h5 id="what-will-happen-exactly"><strong>What will happen exactly?</strong></h5> <p>Parsl will construct the workflow internally and be able to manage the intresic dependencies between the jobs. Two jobs that do not depends on each other can possibly run at the same time. To make things clearer I made the diagram below that summarize what is happening.</p> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/grid_phonon_flow-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/grid_phonon_flow-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/grid_phonon_flow-1400.webp"></source> <img src="/assets/img/grid_phonon_flow.png" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <div class="caption"> Schematic of the workflow, all `Atoms` object will run concurently, similarly all identical colors within each subtask can run concurently as well. This makes the problem embarrassingly parallel. </div> <p>Depending on the number of workers you have set, you will see as many concurrent calculations, other tasks will be queued and run as soon as a worker is available.</p> <hr> <h5 id="where-is-the-output"><strong>Where is the output?</strong></h5> <p>When using Parsl things are a little bit different, the output will mainly be located in the <code class="language-plaintext highlighter-rouge">runinfo</code> dir located in the current working directory. This directory will contain a lot of information about the workflow, including the Parsl logs. You can see the log for each worker in the <code class="language-plaintext highlighter-rouge">runinfo/&lt;executor_label&gt;</code> directory.</p> <hr> <h5 id="i-want-to-use-a-different-interface-then-slurmsrun-how"><strong>I want to use a different interface then slurm/srun, how?</strong></h5> <p>Parsl is very flexible and can be used with a <a href="https://parsl.readthedocs.io/en/stable/userguide/configuring.html" rel="external nofollow noopener" target="_blank">lot of different interfaces</a>. The <code class="language-plaintext highlighter-rouge">SlurmProvider</code> is only one of them. However, running MPI apps is a tricky business, as of now (25th March 2024), Quacc does not support command that do not automatically allocate ressources for a job such as mpirun/mpiexec or other exotic executables. The underlying technical reason is that Quacc do not communicate to Parsl the size of each job. This is currently <a href="https://github.com/Quantum-Accelerators/quacc/issues/1886" rel="external nofollow noopener" target="_blank">being implemented</a>.</p> <hr> <h5 id="what-if-one-job-fails"><strong>What if one job fails?</strong></h5> <p>Parsl is able to handle this, if a job fails, every other jobs that do not have the failed job as a dependency will run. This is a very powerful feature that allows to run high-throughput workflows without having to worry about too much about the stability of the system. Be aware that the <code class="language-plaintext highlighter-rouge">future.result()</code> will still raise an exception if a job fails.</p> </div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Tom Demeyere. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: March 26, 2024. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?07b8786bab9b4abe90d10e61f7d12ff7" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>