<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Use Parsl to create concurrent computational chemistry workflows | Tom Demeyere </title> <meta name="author" content="Tom Demeyere"> <meta name="description" content="Quacc &amp; Parsl, concurrent workflows for DFT calculations."> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://tomdemeyere.github.io/blog/2024/workflows-manager-for-dft/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Tom</span> Demeyere </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Use Parsl to create concurrent computational chemistry workflows</h1> <p class="post-meta"> Created in March 20, 2024 </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/quacc"> <i class="fa-solid fa-hashtag fa-sm"></i> Quacc</a>   <a href="/blog/tag/dft"> <i class="fa-solid fa-hashtag fa-sm"></i> DFT</a>   <a href="/blog/tag/espresso"> <i class="fa-solid fa-hashtag fa-sm"></i> Espresso</a>   <a href="/blog/tag/parsl"> <i class="fa-solid fa-hashtag fa-sm"></i> Parsl</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>A few weeks ago I posted my <a href="https://tomdemeyere.github.io/blog/2024/quacc-espresso/">first blog post</a> where I explained how to use the <a href="https://github.com/Quantum-Accelerators/quacc/" rel="external nofollow noopener" target="_blank">Quantum Accelerator (Quacc)</a> package to run DFT calculations with Quantum Espresso. Quacc allows you to link your favorite DFT code to a workflow manager, in this blog post I will show you how to run Quantum Espresso calculations using Quacc and the Parsl workflow engine to create comp-chem workflows. The main point being to run multiple calculations concurrently on your local machine or on a high-performance computing cluster.</p> <h3 id="quacc--parsl-tutorial">Quacc &amp; Parsl tutorial</h3> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/bitmap-480.webp 480w,/assets/img/bitmap-800.webp 800w,/assets/img/bitmap-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/bitmap.png" class="img-fluid rounded" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>If you never run a Quacc calculation before, I recommend you to either read the <a href="https://quantum-accelerators.github.io/quacc/" rel="external nofollow noopener" target="_blank">Quacc documentation</a> or read my <a href="https://tomdemeyere.github.io/blog/2024/quacc-espresso/">previous blog post</a>. For now, I will assume you have Quacc installed and that you have set up the configuration file correctly.</p> <p>Before we start, you will need to install <a href="https://parsl-project.org" rel="external nofollow noopener" target="_blank">Parsl</a>:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>parsl
</code></pre></div></div> <p>Now that you have Parsl installed, you can configure Quacc to use this workflow engine by changing your <code class="language-plaintext highlighter-rouge">.quacc.yaml</code></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>quacc <span class="nb">set </span>WORKFLOW_ENGINE parsl
</code></pre></div></div> <p>The aim of the tutorial is to compute the phonon dispersion of multiple bulk crystals using the espresso <code class="language-plaintext highlighter-rouge">ph.x</code> code. The <code class="language-plaintext highlighter-rouge">grid_phonon_flow</code> <a href="https://quantum-accelerators.github.io/quacc/reference/quacc/recipes/espresso/phonons.html#quacc.recipes.espresso.phonons.grid_phonon_flow" rel="external nofollow noopener" target="_blank">available in Quacc</a> will make this problem embarrassingly parallel by performing each representation of each q-points separately. Using Parsl these calculations are then done concurrently automatically depending on the resources available.</p> <p>The base code presented in this tutorial is fairly simple, the most complex part being the configuration. It first runs a variable-cell relaxation, and then uses the results to run the phonon calculation. From there it extracts the force constant using <code class="language-plaintext highlighter-rouge">q2r.x</code> and then call <code class="language-plaintext highlighter-rouge">matdyn.x</code> to compute the phonon dispersion on an arbitrary q-point grid. For now, let’s skip the technical details and focus on the functions being called:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@subflow</span>
<span class="k">def</span> <span class="nf">grid_phonon_dos_subflow</span><span class="p">(</span><span class="n">atoms_list</span><span class="p">):</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">atoms_list</span><span class="p">:</span>
        <span class="n">grid_phonon_results</span> <span class="o">=</span> <span class="nf">grid_phonon_flow</span><span class="p">(</span>
            <span class="n">atoms</span><span class="p">,</span>
            <span class="n">job_params</span><span class="o">=</span><span class="n">grid_phonon_params</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">q2r_results</span> <span class="o">=</span> <span class="nf">q2r_job</span><span class="p">(</span><span class="n">grid_phonon_results</span><span class="p">[</span><span class="sh">"</span><span class="s">dir_name</span><span class="sh">"</span><span class="p">],</span> <span class="o">**</span><span class="n">q2r_params</span><span class="p">)</span>
        <span class="n">matdyn_results</span> <span class="o">=</span> <span class="nf">matdyn_job</span><span class="p">(</span><span class="n">q2r_results</span><span class="p">[</span><span class="sh">"</span><span class="s">dir_name</span><span class="sh">"</span><span class="p">],</span> <span class="o">**</span><span class="n">matdyn_params</span><span class="p">)</span>
        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">matdyn_results</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></div> <ul> <li> <code class="language-plaintext highlighter-rouge">grid_phonon_flow</code> is a pre-made <code class="language-plaintext highlighter-rouge">@flow</code> in Quacc, that contains multiple <code class="language-plaintext highlighter-rouge">@job</code>, details can be found in the documentation.</li> <li> <code class="language-plaintext highlighter-rouge">q2r_job</code> is a pre-made <code class="language-plaintext highlighter-rouge">@job</code> that runs the <code class="language-plaintext highlighter-rouge">q2r.x</code>.</li> <li> <code class="language-plaintext highlighter-rouge">matdyn_job</code> is a pre-made <code class="language-plaintext highlighter-rouge">@job</code> that runs the <code class="language-plaintext highlighter-rouge">matdyn.x</code>.</li> </ul> <p>The aim is then simple, we take a list of ASE <code class="language-plaintext highlighter-rouge">Atoms</code> objects, and we run this custom workflow for each of them. Each results are then stored in a list and returned. Now that we have to core of the workflow we have to configure Parsl.</p> <hr> <h5 id="setting-up-parsl"><strong>Setting up Parsl</strong></h5> <p>Parsl runs locally and will submit each job to an HPC scheduler (Slurm in this tutorial). All the options need to be specified via the Parsl configuration.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">parsl.config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="n">parsl.executors</span> <span class="kn">import</span> <span class="n">HighThroughputExecutor</span>
<span class="kn">from</span> <span class="n">parsl.launchers</span> <span class="kn">import</span> <span class="n">SimpleLauncher</span>
<span class="kn">from</span> <span class="n">parsl.providers</span> <span class="kn">import</span> <span class="n">SlurmProvider</span>

<span class="n">CONFIG</span> <span class="o">=</span> <span class="nc">Config</span><span class="p">(</span>
    <span class="n">executors</span><span class="o">=</span><span class="p">[</span>
        <span class="nc">HighThroughputExecutor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">short-large</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">max_workers</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>  <span class="c1"># max number of @job to run concurently.
</span>            <span class="n">cores_per_worker</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span>  <span class="c1"># number of cores per worker, &lt; 1 to oversubscribe.
</span>            <span class="n">provider</span><span class="o">=</span><span class="nc">SlurmProvider</span><span class="p">(</span>
                <span class="n">account</span><span class="o">=</span><span class="sh">"</span><span class="s">e89-soto</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># your account code.
</span>                <span class="n">qos</span><span class="o">=</span><span class="sh">"</span><span class="s">short</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># which quality of service.
</span>                <span class="n">worker_init</span><span class="o">=</span><span class="n">worker_init</span><span class="p">,</span>  <span class="c1"># bash lines that will run before each @job
</span>                <span class="n">walltime</span><span class="o">=</span><span class="sh">"</span><span class="s">00:20:00</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">nodes_per_block</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>  <span class="c1"># nodes for each slurm job (block)
</span>                <span class="n">cores_per_node</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># How many threads to use per parsl worker.
</span>                <span class="n">partition</span><span class="o">=</span><span class="sh">"</span><span class="s">standard</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">init_blocks</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># To be kept to 0, especially if you are using different executors.
</span>                <span class="n">max_blocks</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Max number of slurm_jobs.
</span>                <span class="n">launcher</span><span class="o">=</span><span class="nc">SimpleLauncher</span><span class="p">(),</span>  <span class="c1"># Control where Parsl will live,
</span>            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">parsl</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">)</span>
</code></pre></div></div> <p>The terminology is a bit different from what you might be used to, here is a quick summary:</p> <ul> <li> <p><code class="language-plaintext highlighter-rouge">blocks</code> is the number of actual Slurm jobs. You have total control over that by using the keywords <code class="language-plaintext highlighter-rouge">init_blocks</code>, <code class="language-plaintext highlighter-rouge">min_blocks</code> and <code class="language-plaintext highlighter-rouge">max_blocks</code>.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">workers</code> is also a concept introduced by Parsl, this is a computing unit that will take care of running a <code class="language-plaintext highlighter-rouge">@job</code>. In practice, this number will dictate how many of your <code class="language-plaintext highlighter-rouge">@job</code>’s can run concurrently.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">launcher</code> dictates how the Parsl command is wrapped before being launched, the <code class="language-plaintext highlighter-rouge">SimpleLauncher</code> used here means that it does not use any wrapping; the Parsl process will only run on the mother node. The <code class="language-plaintext highlighter-rouge">SingleNodeLauncher</code> will run the parsl process on each node, and might be used as well.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">cores_per_worker</code> is the number of cores that will be used by each worker. In the case of computational chemistry, you will often see that it is set to something very low, this means that multiple workers can live on the same threads. There is no need to tweak <code class="language-plaintext highlighter-rouge">cores_per_node</code>.</p> </li> </ul> <p>These parallelization options are not to be seen as the ones that will affect your individual DFT calculations but more as a <strong>total</strong> parallelization that will dictate how many resources this <code class="language-plaintext highlighter-rouge">executor</code> can use. Your DFT calculations are then dispatched inside this executor, their parallelization will be specified later.</p> <p><code class="language-plaintext highlighter-rouge">worker_init</code> should have everything you need to run espresso, the machine I use does not have access to the home system from the compute nodes, so I need to to load a ‘scratch’ bashrc that contains the conda init. This is done by adding the following lines:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">worker_init</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
source /path/inside/scratch/.bashrc # Load your bashrc that contains the conda init.
conda activate quacc # Activate the conda environment.

export QUACC_CONFIG_FILE=/path/inside/scratch/.quacc.yaml # Quacc config in scratch space.

module load PrgEnv-gnu
module load cray-fftw cray-hdf5-parallel

export LD_LIBRARY_PATH=$CRAY_LD_LIBRARY_PATH:$LD_LIBRARY_PATH
</span><span class="sh">"""</span>
</code></pre></div></div> <hr> <h5 id="specifying-parameters-and-parallelization"><strong>Specifying parameters and parallelization</strong></h5> <p>Before running the workflow you need to setup the parameters that will be sent to each flow and job, namely the <code class="language-plaintext highlighter-rouge">grid_phonon_params</code>, <code class="language-plaintext highlighter-rouge">matdyn_params</code>, and <code class="language-plaintext highlighter-rouge">q2r_params</code>. For the parallelization, currently, the Quacc Espresso interface uses the new <code class="language-plaintext highlighter-rouge">parallel_info</code> mechanism introduced in ASE. Here we will use the <code class="language-plaintext highlighter-rouge">srun</code> command with its options. This is done by setting the <code class="language-plaintext highlighter-rouge">parallel_info</code> variable in the <code class="language-plaintext highlighter-rouge">grid_phonon_params</code> and <code class="language-plaintext highlighter-rouge">matdyn_params</code> dictionaries.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parallel_info</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">srun</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">-vv</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">--hint=nomultithread</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">--distribution=block:block</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">-N</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">-n</span><span class="sh">"</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">-c</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>
<span class="c1"># pw.x parameters
</span><span class="n">pw_input_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">control</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">forc_conv_thr</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.0001</span><span class="p">},</span>
    <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">occupations</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">smearing</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">degauss</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">smearing</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">cold</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">electrons</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">conv_thr</span><span class="sh">"</span><span class="p">:</span> <span class="mf">1e-12</span><span class="p">,</span> <span class="sh">"</span><span class="s">mixing_mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">TF</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mixing_beta</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">},</span>
    <span class="sh">"</span><span class="s">ions</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span>
    <span class="sh">"</span><span class="s">cell</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">press_conv_thr</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
<span class="p">}</span>
<span class="c1"># ph.x parameters
</span><span class="n">ph_input_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">inputph</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">tr2_ph</span><span class="sh">"</span><span class="p">:</span> <span class="mf">1.0e-12</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">alpha_mix(1)</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">nmix_ph</span><span class="sh">"</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ldisp</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">nq1</span><span class="sh">"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">nq2</span><span class="sh">"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">nq3</span><span class="sh">"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
<span class="c1"># matdyn.x parameters
</span><span class="n">matdyn_input_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">asr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">crystal</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">dos</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">nk1</span><span class="sh">"</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">nk2</span><span class="sh">"</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">nk3</span><span class="sh">"</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">deltaE</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
<span class="c1"># let's gather all the parameters to send to grid_phonon_flow
</span><span class="n">grid_phonon_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">relax_job</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">input_data</span><span class="sh">"</span><span class="p">:</span> <span class="n">pw_input_data</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">kspacing</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">relax_cell</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parallel_info</span><span class="sh">"</span><span class="p">:</span> <span class="n">parallel_info</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">ph_job</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">input_data</span><span class="sh">"</span><span class="p">:</span> <span class="n">ph_input_data</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parallel_info</span><span class="sh">"</span><span class="p">:</span> <span class="n">parallel_info</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
<span class="c1"># let's gather all the parameters to send to q2r_job and matdyn_job
</span><span class="n">matdyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">input_data</span><span class="sh">"</span><span class="p">:</span> <span class="n">matdyn_input_data</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parallel_info</span><span class="sh">"</span><span class="p">:</span> <span class="n">parallel_info</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">q2r_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">parallel_info</span><span class="sh">"</span><span class="p">:</span> <span class="n">parallel_info</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div> <p>All these lines and config are to be placed before the <code class="language-plaintext highlighter-rouge">@subflow</code> “grid_phonon_dos_subflow”. You can access the complete script on my <a href="https://github.com/tomdemeyere/tomdemeyere.github.io/blob/master/code_snippets/blog-post-2.py" rel="external nofollow noopener" target="_blank">GitHub page</a>. At this point, you can create an atoms list of bulk crystals and call the function.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">ase.build</span> <span class="kn">import</span> <span class="n">bulk</span>

<span class="n">atoms_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nf">bulk</span><span class="p">(</span><span class="sh">"</span><span class="s">Al</span><span class="sh">"</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="nf">bulk</span><span class="p">(</span><span class="sh">"</span><span class="s">Cu</span><span class="sh">"</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="nf">bulk</span><span class="p">(</span><span class="sh">"</span><span class="s">Ag</span><span class="sh">"</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="nf">bulk</span><span class="p">(</span><span class="sh">"</span><span class="s">Au</span><span class="sh">"</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="nf">bulk</span><span class="p">(</span><span class="sh">"</span><span class="s">Ni</span><span class="sh">"</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="nf">bulk</span><span class="p">(</span><span class="sh">"</span><span class="s">Pd</span><span class="sh">"</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="nf">bulk</span><span class="p">(</span><span class="sh">"</span><span class="s">Pt</span><span class="sh">"</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="nf">bulk</span><span class="p">(</span><span class="sh">"</span><span class="s">Li</span><span class="sh">"</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">future</span> <span class="o">=</span> <span class="nf">grid_phonon_dos_subflow</span><span class="p">(</span><span class="n">atoms_list</span><span class="p">)</span>
</code></pre></div></div> <p>At this stage, running the Python script doesn’t produce any output. This is because Parsl is now handling the function call, and it is only generating the <a href="https://en.wikipedia.org/wiki/Directed\_acyclic\_graph" rel="external nofollow noopener" target="_blank">Directed Acyclic Graph (DAG)</a>, which is an internal representation of the workflow. The returned object is a future object. To actually execute the workflow, the future object needs to be resolved by calling the <code class="language-plaintext highlighter-rouge">Future.result()</code> method.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">results</span> <span class="o">=</span> <span class="n">future</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
</code></pre></div></div> <p>If you have important disparities between the size of your jobs, Parsl allows you to define multiple executors. To do this, you just need to add a new executor to the <code class="language-plaintext highlighter-rouge">CONFIG</code> object. You simply need to add one more executor to the list. I will not show it here, but the code is available on my <a href="https://github.com/tomdemeyere/tomdemeyere.github.io/blob/master/code_snippets/blog-post-2.py" rel="external nofollow noopener" target="_blank">GitHub</a>. Using Quacc each job can be linked to a single executor to make sure to run your jobs using the resources you want.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">q2r_job_custom</span> <span class="o">=</span> <span class="nf">redecorate</span><span class="p">(</span><span class="n">q2r_job</span><span class="p">,</span> <span class="nf">job</span><span class="p">(</span><span class="n">executors</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">q2r</span><span class="sh">"</span><span class="p">]))</span>
<span class="n">matdyn_job_custom</span> <span class="o">=</span> <span class="nf">redecorate</span><span class="p">(</span><span class="n">matdyn_job</span><span class="p">,</span> <span class="nf">job</span><span class="p">(</span><span class="n">executors</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">matdyn</span><span class="sh">"</span><span class="p">]))</span>
</code></pre></div></div> <hr> <h5 id="what-will-happen-exactly"><strong>What will happen exactly?</strong></h5> <p>Parsl will construct the workflow internally and be able to manage the intrinsic dependencies between the jobs. As a consequence, two jobs that do not depend on each other can possibly run at the same time. To make things clearer I made the diagram below that summarizes what is happening.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/grid_phonon_flow-480.webp 480w,/assets/img/grid_phonon_flow-800.webp 800w,/assets/img/grid_phonon_flow-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/grid_phonon_flow.png" class="img-fluid rounded" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <div class="caption"> Schematic of the workflow, all `Atoms` objects will run concurrently, similarly all identical colors within each subtask can run concurrently as well. This makes the problem embarrassingly parallel. </div> <p>Depending on the number of workers you have set, you will see as many concurrent calculations, other tasks will be queued and run as soon as a <code class="language-plaintext highlighter-rouge">worker</code> is available.</p> <hr> <h5 id="where-is-the-output"><strong>Where is the output?</strong></h5> <p>Using Parsl Quacc’s output is still located depending on the settings in the <code class="language-plaintext highlighter-rouge">.quacc.yaml</code> file, as described in the <a href="https://quantum-accelerators.github.io/quacc/user/settings/file_management.html" rel="external nofollow noopener" target="_blank">documentation</a>. Nothing changed there.</p> <p>Parsl will also output useful information, by default this is located in a directory named <code class="language-plaintext highlighter-rouge">runinfo</code> in the current working directory. If you find yourself struggling to debug your code when using Parsl, check out their <a href="https://parsl.readthedocs.io/en/stable/faq.html#how-can-i-debug-a-parsl-script" rel="external nofollow noopener" target="_blank">documentation</a>.</p> <hr> <h5 id="what-if-one-job-fails"><strong>What if one job fails?</strong></h5> <p>Parsl is able to handle this, if a job fails, every other jobs that do not have the failed job as a dependency will run. This is a very powerful feature that allows to run high-throughput workflows without having to worry too much about the stability of the system. Be aware that the <code class="language-plaintext highlighter-rouge">future.result()</code> will still raise an exception if a job fails.</p> <hr> <p>That’s it for this blog post! You will probably need to tweak the configuration to fit your needs, but this should give you a good starting point. Do not hesitate to contact the Parsl support on Slack if you need help, they are very responsive, otherwise, feel free to ask them in the comments below.</p> </div> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Tom Demeyere. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: March 22, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script>let searchTheme=determineComputedTheme();const ninjaKeys=document.querySelector("ninja-keys");"dark"===searchTheme?ninjaKeys.classList.add("dark"):ninjaKeys.classList.remove("dark");const openSearchModal=()=>{const e=$("#navbarNav");e.hasClass("show")&&e.collapse("hide"),ninjaKeys.open()};</script> <script>const ninja=document.querySelector("ninja-keys");ninja.data=[{id:"nav-about",title:"about",section:"Navigation",handler:()=>{window.location.href="/"}},{id:"nav-blog",title:"blog",description:"",section:"Navigation",handler:()=>{window.location.href="/blog/"}},{id:"nav-publications",title:"publications",description:"",section:"Navigation",handler:()=>{window.location.href="/publications/"}},{id:"nav-cv",title:"cv",description:"",section:"Navigation",handler:()=>{window.location.href="/cv/"}},{id:"post-use-parsl-to-create-concurrent-computational-chemistry-workflows",title:"Use Parsl to create concurrent computational chemistry workflows",description:"Quacc & Parsl, concurrent workflows for DFT calculations.",section:"Posts",handler:()=>{window.location.href="/blog/2024/workflows-manager-for-dft/"}},{id:"post-use-the-quantum-accelerator-to-improve-your-dft-calculations",title:"Use the Quantum Accelerator to improve your DFT calculations",description:"I recently discovered Quacc and I implemented an interface for the Quantum Espresso code. Let's try it!",section:"Posts",handler:()=>{window.location.href="/blog/2024/quacc-espresso/"}},{id:"news-a-simple-inline-announcement",title:"A simple inline announcement.",description:"",section:"News"},{id:"news-a-simple-inline-announcement-with-markdown-emoji-sparkles-smile",title:'A simple inline announcement with Markdown emoji! <img class="emoji" title=":sparkles:" alt=":sparkles:" src="https://github.githubassets.com/images/icons/emoji/unicode/2728.png" height="20" width="20"> <img class="emoji" title=":smile:" alt=":smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f604.png" height="20" width="20">',description:"",section:"News"},{id:"socials-email",title:"Send email",section:"Socials",handler:()=>{window.open("mailto:%74%6F%6D.%64%6D%72%65@%67%6D%61%69%6C.%63%6F%6D","_blank")}},{id:"socials-orcid",title:"ORCID",section:"Socials",handler:()=>{window.open("https://orcid.org/0000-0002-5023-6156","_blank")}},{id:"socials-github",title:"GitHub",section:"Socials",handler:()=>{window.open("https://github.com/tomdemeyere","_blank")}},{id:"socials-linkedin",title:"LinkedIn",section:"Socials",handler:()=>{window.open("https://www.linkedin.com/in/tom-demeyere-091144b9","_blank")}},{id:"socials-gitlab",title:"GitLab",section:"Socials",handler:()=>{window.open("https://gitlab.com/tomdemeyere","_blank")}},{id:"light-theme",title:"Change theme to light",description:"Change the theme of the site to Light",section:"Theme",handler:()=>{setThemeSetting("light")}},{id:"dark-theme",title:"Change theme to dark",description:"Change the theme of the site to Dark",section:"Theme",handler:()=>{setThemeSetting("dark")}},{id:"system-theme",title:"Use system default theme",description:"Change the theme of the site to System Default",section:"Theme",handler:()=>{setThemeSetting("system")}}];</script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>